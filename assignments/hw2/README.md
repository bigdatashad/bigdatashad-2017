# Домашнее задание 2

Развитие социальной сети Zwitter привело к тому, что основатели стартапа дополнительно начали анализировать лайки пользователей и источники трафика.

## Что надо делать?

В этом домашнем задании вам необходимо помочь основателям наладить ежедневный расчет дополнительных метрик с помощью Apache Spark и предоставить доступ к ним через HTTP API первого домашнего задания,

Ниже вы можете найти более подробную информацию по следующим вопросам:

  * [Исходные данные](#Исходные-данные)
  * [Рассчитываемые метрики](#Рассчитываемые-метрики)
  * [Требования](#Требования)
  * [Критерии сдачи задания](#Критерии-сдачи-задания)
  * [Спецификация HTTP API](#Спецификация-http-api)


## Исходные данные

В этом задании используются те же исходные данные, что и в первом домашнем задании: логи доступа к веб-серверу.

Напомним, что из каждой записи в логе можно выделить **пользователя** и **посещенный профиль**: пользователь определяется IP-адресом, а посещенный профиль -- идентификатором, закодированном в URI запроса в виде `idNNNNN`.

К примеру, по записи:

```
195.206.123.39 - - [24/Sep/2016:12:32:53 +0400] "GET /id18222 HTTP/1.1" 200 10703 "http://bing.com/" "Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/37.0.2062.94 Safari/537.36"
```

Можно сказать, что пользователь **195.206.123.39** посетил профиль **id18222**. А реферером, т.е. источником трафика для этого посещения была страница **http://bing.com/**.

Также в данном задании вам будут важны лайки. Иногда некоторые пользователи ставят лайк профилю. В логах это соответствует хиту с параметром `like=1`, например:

```
195.206.123.39 - - [24/Sep/2016:12:32:53 +0400] "GET /id18222?like=1 HTTP/1.1" 200 10703 "http://bing.com/" "Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/37.0.2062.94 Safari/537.36"
```

По данному хиту можно сказать, что пользователь **195.206.123.39** полайкал профиль **id18222**. Важно, что лайк **не** является посещением профиля.

## Рассчитываемые метрики

Вам необходимо расчитать метрики для каждого дня логов:

 * `session_referers` -- статистика по источникам трафика для сессий (что такое сессия см. в первом домашнем задании), т.е. количество сессий за день, которые начались с того или иного реферера; отрезать и преобразовывать в реферере ничего не нужно; если в начале сессии идут несколько хитов с одинаковым timestamp, то в качестве реферера берем лексикографически наибольший;
 * `profile_liked_three_days` -- суммарное количество профилей пользователей, которых лайкали ВСЕ последние три дня подряд (то есть в день X-2, X-1 и X);

Для расчета метрик необходимо игнорировать неуспешные запросы (статус не равен 200).

## Требования

Ваше решение должно удовлетворять следующим требованиям:

  * ежедневные метрики необходимо реализовать с использованием фреймворка Apache Spark;
  * ежедневные метрики должны быть готова к 9 утра следующего дня (к примеру, результат за 25.11 должны быть готовы к 09:00 26.11); готовность вычисленной метрики определяется возможностью выполнения запроса через HTTP API;
  * время ответа HTTP API не должно превышать 10 секунд;
  * процесс расчета должен стабильно работать начиная с момента сдачи задания и до окончания курса, при этом ваше решение _не должно_ терять просчитанные данные за прошедшие дни (в том числе и после удаления исходных данных из HDFS).

## Критерии сдачи задания

За данное домашнее задание возможно заработать 5 попугаев.

  * за вычисленную метрику `session_referers` выдается *два* (2) попугая;
  * за вычисленную метрику `profile_liked_three_days` выдается *три* (3) попугая;

До 19.11.2017 включительно (заочникам +7 дней) необходимо реализовать вычисление метрик.

Правила зачета метрик такие же, как в ДЗ-1. Т.е. если есть день, когда метрика готова к 9 утра и правильная, то она засчитывается. За каждые 10 дней правильных -- +1 попугай.

## Спецификация HTTP API

Ваше решение должно расширить HTTP API вашего первого домашнего задания. Если вы не выполняли первое домашнее задание, создайте новое HTTP API по описанию из первого ДЗ.

HTTP API должно научиться выдавать новые метрики. Если у вас нет данных за какую-либо дату, то опустите соответствующий ключ из ответа.

Пример запроса:

```
GET /api/hw1?start_date=2016-12-01&end_date=2016-12-01
```

Пример ответа:

```json
{
  "2016-12-01": {
    ...
    "profile_liked_three_days" : 4
    "session_referers": {
      "http://google.com/": 48451,
      "http://bing.com/": 24867,
      "http://yandex.ru/yandsearch": 46602,
    }
  }
}
```
