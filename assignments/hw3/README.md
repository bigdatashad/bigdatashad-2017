# Домашнее задание 3

С расширением аудитории Zwitter, с развитием функционала социальной сети Zwitter, выросли требования и пожелания 
основателей стартапа. Теперь основатели-стартапщики хотят получать заранее вычисленную информацию о конкретных 
пользователях социальной сети, при этом необходимое требование, чтобы запросы выполнялись максимально быстро.
 
## Что надо делать?

Во втором домашнем задании вам необходимо помочь основателями решить следующие задачи:
 
  * настроить ежедневный расчет метрик для всех пользователей социальной сети по собираемым в HDFS логам на MapReduce или Spark,
  * настроить сохранение рассчитанных метрик в таблицы HBase,
  * предоставить доступ к данным, хранящимся в HBase, через HTTP API.

Ниже вы можете найти более подробную информацию по следующим вопросам:

  * [Исходные данные](#Исходные-данные)
  * [Рассчитываемые метрики](#Рассчитываемые-метрики)
  * [Требования](#Требования)
  * [Критерии сдачи задания](#Критерии-сдачи-задания)
  * [Процесс сдачи задания](#Процесс-сдачи-задания)
  * [Спецификация HTTP API](#Спецификация-http-api)
  * [Дополнительные комментарии](#Дополнительные-комментарии)


## Исходные данные

В этом задании используются те же исходные данные, что и в первом домашнем задании: логи доступа к веб-серверу.

Из каждой записи в логе можно выделить **пользователя** и **посещенный профиль**: пользователь определяется IP-адресом, а посещенный профиль -- идентификатором, закодированном в URI запроса в виде `idNNNNN`.

К примеру, по записи

```
195.206.123.39 - - [24/Sep/2016:12:32:53 +0400] "GET /id18222 HTTP/1.1" 200 10703 "http://bing.com/" "Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/37.0.2062.94 Safari/537.36"
```

Можно сказать, что пользователь **195.206.123.39** посетил профиль **id18222**.

Также в данном задании вам будут важны лайки. Иногда некоторые пользователи ставят лайк профилю. В логах это соответствует хиту с параметром `like=1`, например

```
195.206.123.39 - - [24/Sep/2016:12:32:53 +0400] "GET /id18222?like=1 HTTP/1.1" 200 10703 "http://bing.com/" "Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/37.0.2062.94 Safari/537.36"
```

По данному хиту можно сказать, что пользователь **195.206.123.39** полайкал профиль **id18222**.

Как и в первом домашнем задании, для расчета целевых метрик вам стоит рассматривать только успешные (HTTP-код 200)
запросы к веб-сайту. Неуспешные запросы стоит игнорировать.

## Рассчитываемые метрики

Вам необходимо посчитать набор метрик для каждого пользователя социальной сети, для каждого профиля социальной сети,
а также перекрестную метрику по пользователям и профилям.

Метрики по профилям:

 * `profile_hits(profile, day) -> [(hour, count)]` -- суммарное количество просмотров определенного профиля всеми пользователями веб-сайта (распределение по часам);
 * `profile_users(profile, day) -> [(hour, count)]` -- суммарное количество уникальных пользователей, просматривавших данный профиль (распределение по часам).

Перекрестные метрики:

 * `user_most_visited_profiles(user, day) -> [profile]` -- множество профилей, просмотренных данным пользователем, в порядке убывания количества просмотров (при совпадении количества просмотров упорядочить профили лексикографически; метрика дневная).

 * `profile_last_three_liked_users(profile, day) -> [user]` -- последние три пользователя за пять последних дней, полайкавшие данный профиль, в порядке убывания времени посещения (первым в ответе самый последний полайкавший пользователь; дни считаются включительно, то есть при запросе за день X должны быть возвращены пользователи, которые полайкали в дни X, X-1, X-2, X-3, X-4).

## Требования

Ваше решение должно удовлетворять следующим требованиям:

  * вычисленные метрики должны располагаться в таблицах вида `bigdatashad_USER_TABLENAME`, где `USER` -- ваш логин, `TABLENAME` -- выбранное вами имя таблицы;
  * построенные таблицы не должны содержать более 500 столбцов;
  * вычисление метрик для выполнения запросов должно происходить в результате выполнения MR или Spark задач на кластере и сохраняться в HBase
    (если вы пишете на Python, то можете использовать библиотеку HappyBase; если пишете на Java -- нативную библиотеку HBase).
  * вычисленные данные должны быть готовы к 9 утра следующего дня (к примеру, результаты за 25.10
    должны быть готовы к 09:00 26.10); готовность вычисленных данных определяется возможностью выполнения запросов через HTTP API;
  * время ответа HTTP API не должно превышать 5 секунд;

## Критерии сдачи задания

За данное домашнее задание возможно заработать 10 попугаев.

  * за вычисленную метрику `profile_hits` выдается *один* (1) попугай;
  * за вычисленную метрику `profile_users` выдается *два* (2) попугая;
  * за вычисленную метрику `user_most_visited_profiles` выдается *три* (3) попугая;
  * за вычисленную метрику `profile_last_three_liked_users` выдается *четыре* (4) попугая;

До 10.12 (заочникам +7 дней) включительно необходимо реализовать вычисление метрик и зарегистрировать ваше решение в системе. Если ваше HTTP API работало для предыдущих заданий, то повторно регистрировать его не нужно. За каждые 5 правильных (т.е. верных и вовремя посчитанных) дней каждой метрики выдается по одному бонус-попугаю.

## Процесс сдачи задания

Для самопроверки и сдачи вашего решения вам необходимо будет использовать веб-интерфейс Zwitter,
доступный на порту `8888` машины `hadoop2-00.yandex.ru` (NB: для доступа к веб-интерфейсу
вам необходимо пробросить `8888`-й порт на локальную машину).

Как и для ДЗ-1, для проверки корректности ответа вашего HTTP API (т.е. структуры ответа и типа возвращаемых значений) 
вы можете использовать страницу по адресу `http://hadoop2-00.yandex.ru:8888/ysda/hw1/playground`.
На этой же странице можно зарегистрировать ваше HTTP API (если еще не) кнопкой Submit.

## Спецификация HTTP API

Ваше решение должно уметь отвечать на запрос типа `GET` к URI `/api/hw3`,

Параметры запроса:

  * `start_date` -- начальная дата в формате `YYYY-MM-DD` (включительно),
  * `end_date` -- конечная дата в формате `YYYY-MM-DD` (включительно),
  * `profile_id` -- идентификатор профиля в формате `idNNNNN`.
  * `user_ip` -- IP-адрес пользователя в формате `A.B.C.D`.

В ответе должен быть JSON-документ с ключами, соответствующими дням из заданного диапазона.
Для каждого дня -- вычисленные метрики, значения метрик имеют такие типы:

  * `profile_hits`, `profile_users` -- массивы из 24 целых чисел со значениями для каждого часа, 0 -- если для этого часа посещений не было
  * `user_most_visited_profiles` -- массив строк, содержащий профили в формате `idXXXXX`
  * `profile_last_three_liked_users` -- массив строк из 3-х элементов, содержащий IP-адреса.
 
Если метрика за данный день не вычислена, то выводить её не нужно. Если метрик за день нет, 
то можно за этот день выводить пустой словарь или не выводить день вообще.

Пример запроса:

```
GET /api/hw2?start_date=2016-10-01&end_date=2016-10-02&profile_id=id10001&user_ip=192.168.0.190
```

Пример ответа:

```json
{
  "2016-10-01": {
    "profile_hits": [10, 14, 9, 1, 0, 0, 0, ..., 4],
    "profile_users": [9, 14, 9, 1, 0, 0, 0, ..., 4],
    "user_most_visited_profiles": ["id10001", "id10002"],
    "profile_last_three_liked_users": ["81.10.20.30", "81.20.10.40"],
  },
  "2016-10-02": {
    ...
  }
}
```

## Дополнительные комментарии

  * Продумайте количество и схему таблиц HBase для хранения метрик. Они должны быть оптимальны
для получения каждой метрики по-отдельности. Получение всех метрик одним запросом обусловлено лишь удобством проверки.
  * Полезные материалы: [Introduction to HBase Schema Design](http://0b4af6cdc2f0c5998459-c0245c5c937c5dedcca3f1764ecc9b2f.r43.cf2.rackcdn.com/9353-login1210_khurana.pdf).
